name: Release CLI

on:
  push:
    tags:
      - "v*.*.*"
  workflow_dispatch:
    inputs:
      version:
        description: 'Version to build (without v prefix, e.g. 1.0.0-dev)'
        required: false
        default: '0.0.0-dev'
      publish_npm:
        description: 'Publish to NPM'
        type: boolean
        required: false
        default: false

permissions:
  contents: write

jobs:
  test:
    name: Test (CLI)
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: dtolnay/rust-toolchain@stable

      - uses: Swatinem/rust-cache@v2
        with:
          workspaces: |
            cli

      - name: Test
        working-directory: cli
        run: cargo test --locked

  create-release:
    if: startsWith(github.ref, 'refs/tags/')
    name: Create Release
    needs: test
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Create Release
        uses: softprops/action-gh-release@v2
        with:
          repository: vanthaita/orca-releases
          token: ${{ secrets.PUBLIC_RELEASE_TOKEN }}
          draft: false
          prerelease: false
          generate_release_notes: true

  build-and-upload:
    name: Build & Upload (${{ matrix.target }})
    needs: [test, create-release]
    if: always() && (needs.create-release.result == 'success' || needs.create-release.result == 'skipped')
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        include:
          - os: ubuntu-latest
            target: x86_64-unknown-linux-gnu
            bin: orca
            archive: tar.gz
          - os: macos-latest
            target: x86_64-apple-darwin
            bin: orca
            archive: tar.gz
          - os: windows-latest
            target: x86_64-pc-windows-msvc
            bin: orca.exe
            archive: zip

    steps:
      - uses: actions/checkout@v4

      - name: Compute version
        shell: bash
        run: |
           set -euo pipefail
           if [[ "${{ github.ref }}" == refs/tags/* ]]; then
             VERSION="${GITHUB_REF_NAME#v}"
           else
             VERSION="${{ inputs.version || '0.0.0-dev' }}"
           fi
           echo "VERSION=$VERSION" >> "$GITHUB_ENV"

      - uses: dtolnay/rust-toolchain@stable
        with:
          targets: ${{ matrix.target }}

      - uses: Swatinem/rust-cache@v2
        with:
          workspaces: |
            cli

      - name: Build
        working-directory: cli
        env:
          ORCA_DEFAULT_API_BASE_URL: ${{ vars.ORCA_DEFAULT_API_BASE_URL }}
        run: cargo build --release --locked --target ${{ matrix.target }}

      - name: Package (tar.gz)
        if: matrix.archive == 'tar.gz'
        shell: bash
        run: |
          set -euo pipefail
          mkdir -p dist
          cp "cli/target/${{ matrix.target }}/release/${{ matrix.bin }}" "dist/${{ matrix.bin }}"
          tar -C dist -czf "orca-${{ matrix.target }}.tar.gz" "${{ matrix.bin }}"

      - name: Package (zip)
        if: matrix.archive == 'zip'
        shell: pwsh
        run: |
          New-Item -ItemType Directory -Force -Path dist | Out-Null
          Copy-Item -Force "cli/target/${{ matrix.target }}/release/${{ matrix.bin }}" "dist/${{ matrix.bin }}"
          Compress-Archive -Path "dist/${{ matrix.bin }}" -DestinationPath "orca-${{ matrix.target }}.zip" -Force

      - name: Install WiX (Windows)
        if: matrix.os == 'windows-latest'
        shell: pwsh
        run: |
          dotnet tool install --global wix --version 4.*
          $env:PATH += ";$env:USERPROFILE\.dotnet\tools"

          wix -?

          wix extension add -g WixToolset.UI.wixext/4.0.4

      - name: Build MSI (Windows)
        if: matrix.os == 'windows-latest'
        shell: pwsh
        run: |
          $env:PATH += ";$env:USERPROFILE\.dotnet\tools"
          wix build installer\Orca.wxs -ext WixToolset.UI.wixext -d Version=$env:VERSION -o OrcaSetup-$env:VERSION.msi

      - name: Upload to Public GitHub Release
        if: startsWith(github.ref, 'refs/tags/')
        uses: softprops/action-gh-release@v2
        with:
          files: |
            orca-${{ matrix.target }}.${{ matrix.archive }}
          repository: vanthaita/orca-releases
          token: ${{ secrets.PUBLIC_RELEASE_TOKEN }}
          make_latest: false

      - name: Upload MSI to Public GitHub Release
        if: matrix.os == 'windows-latest' && startsWith(github.ref, 'refs/tags/')
        uses: softprops/action-gh-release@v2
        with:
          files: |
            OrcaSetup-*.msi
          repository: vanthaita/orca-releases
          token: ${{ secrets.PUBLIC_RELEASE_TOKEN }}
          make_latest: false

      - name: Upload Artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: orca-${{ matrix.target }}
          path: |
            orca-${{ matrix.target }}.${{ matrix.archive }}
            OrcaSetup-*.msi

  update-install-script:
    name: Update Install Script
    needs: test
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          path: source

      - name: Update install.sh
        shell: bash
        env:
          GH_TOKEN: ${{ secrets.PUBLIC_RELEASE_TOKEN }}
        run: |
          # Manual clone/setup to handle empty repository
          rm -rf public-repo
          git clone "https://oauth2:${GH_TOKEN}@github.com/vanthaita/orca-releases.git" public-repo
          
          cd public-repo
          # Ensure we are on main, creating it if it doesn't exist (e.g. empty repo)
          if ! git rev-parse --verify HEAD >/dev/null 2>&1; then
             echo "Empty repository. Creating main branch."
             git checkout -b main
          else
             echo "Repository not empty. Checking out main."
             git checkout main || git checkout -b main
          fi

          # Copy file from source (which is checked out in 'source' dir)
          # Note: previous step checked out source to 'source' path.
          echo "Copying install.sh..."
          cp ../source/scripts/install.sh install.sh
          
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          
           git add install.sh
          if git diff --staged --quiet; then
            echo "No changes to install.sh"
          else
            echo "Committing and pushing changes..."
            git commit -m "Update install.sh [skip ci]"
            git push -u origin main
          fi

  publish-npm:
    name: Publish to npm
    needs: build-and-upload
    if: startsWith(github.ref, 'refs/tags/') || (github.event_name == 'workflow_dispatch' && inputs.publish_npm == true)
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          registry-url: 'https://registry.npmjs.org'
          always-auth: true

      - name: Compute version
        shell: bash
        run: |
           set -euo pipefail
           if [[ "${{ github.ref }}" == refs/tags/* ]]; then
             VERSION="${GITHUB_REF_NAME#v}"
           else
             VERSION="${{ inputs.version || '0.0.0-dev' }}"
           fi
           echo "VERSION=$VERSION" >> "$GITHUB_ENV"

      - name: Update package.json version
        working-directory: cli
        run: |
          npm version $VERSION --no-git-tag-version --allow-same-version

      - name: Prepare npm package
        working-directory: cli
        run: |
          # Copy install script
          cp ../scripts/install.js .
          
          # Fix BIN_DIR in install.js for package structure
          # Original: const BIN_DIR = path.join(__dirname, '..', 'cli', 'bin');
          # New:      const BIN_DIR = path.join(__dirname, 'bin');
          sed -i "s|path.join(__dirname, '..', 'cli', 'bin')|path.join(__dirname, 'bin')|" install.js
          
          # Create bin directory and wrapper
          mkdir -p bin
          cat > bin/orca.js << 'EOF'
          #!/usr/bin/env node
          const { spawn } = require('child_process');
          const path = require('path');
          const binPath = path.join(__dirname, process.platform === 'win32' ? 'orca.exe' : 'orca');
          
          const child = spawn(binPath, process.argv.slice(2), { stdio: 'inherit' });
          
          child.on('close', (code) => {
            process.exit(code);
          });
          
          child.on('error', (err) => {
            console.error('Failed to start Orca CLI:', err);
            console.error('This might be because the binary was not installed correctly.');
            console.error('Try running: npm rebuild @vanthaita/orca');
            process.exit(1);
          });
          EOF
          chmod +x bin/orca.js
          
          # Update package.json to point to new files
          npm pkg set scripts.postinstall="node install.js"
          npm pkg set bin.orca="./bin/orca.js"

      - name: Verify npm authentication
        working-directory: cli
        env:
          NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}
        run: npm whoami

      - name: verify package integrity
        working-directory: cli
        run: |
          npm pack
          PACKAGE_FILE=$(find . -name "*.tgz" | head -n 1)
          npm install --no-save "$PACKAGE_FILE"
          
          echo "Testing binary execution..."
          ./node_modules/.bin/orca --version || { echo "Binary failed to run"; exit 1; }
          echo "Binary verified successfully"

      - name: Check NPM Authentication (Dry Run)
        working-directory: cli
        env:
          NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}
        run: npm publish --dry-run

      - name: Publish to npm
        working-directory: cli
        env:
          NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}
        run: |
          npm publish --access public

  update-homebrew:
    name: Update Homebrew Formula
    needs: build-and-upload
    if: false
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          path: source

      - name: Compute version
        shell: bash
        run: |
          VERSION="${GITHUB_REF_NAME#v}"
          echo "VERSION=$VERSION" >> "$GITHUB_ENV"

      - name: Download release artifacts
        env:
          GH_TOKEN: ${{ secrets.PUBLIC_RELEASE_TOKEN }}
        run: |
          gh release download $GITHUB_REF_NAME \
            --repo vanthaita/orca-releases \
            --pattern "orca-x86_64-apple-darwin.tar.gz" \
            --pattern "orca-x86_64-unknown-linux-gnu.tar.gz"

      - name: Compute SHA256
        id: sha
        run: |
          SHA_DARWIN=$(sha256sum orca-x86_64-apple-darwin.tar.gz | cut -d' ' -f1)
          SHA_LINUX=$(sha256sum orca-x86_64-unknown-linux-gnu.tar.gz | cut -d' ' -f1)
          echo "SHA_DARWIN=$SHA_DARWIN" >> "$GITHUB_ENV"
          echo "SHA_LINUX=$SHA_LINUX" >> "$GITHUB_ENV"

      - name: Clone Homebrew tap
        env:
          GH_TOKEN: ${{ secrets.PUBLIC_RELEASE_TOKEN }}
        run: |
          git clone "https://oauth2:${GH_TOKEN}@github.com/vanthaita/homebrew-orca.git" tap
          cd tap
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

      - name: Update formula
        run: |
          cat > tap/Formula/orca.rb << 'EOF'
          class Orca < Formula
            desc "AI-native Git workflow automation for modern developers"
            homepage "https://orcacli.codes"
            version "${{ env.VERSION }}"
            license "MIT"

            on_macos do
              if Hardware::CPU.intel?
                url "https://github.com/vanthaita/orca-releases/releases/download/${{ github.ref_name }}/orca-x86_64-apple-darwin.tar.gz"
                sha256 "${{ env.SHA_DARWIN }}"
              else
                url "https://github.com/vanthaita/orca-releases/releases/download/${{ github.ref_name }}/orca-x86_64-apple-darwin.tar.gz"
                sha256 "${{ env.SHA_DARWIN }}"
              end
            end

            on_linux do
              if Hardware::CPU.intel?
                url "https://github.com/vanthaita/orca-releases/releases/download/${{ github.ref_name }}/orca-x86_64-unknown-linux-gnu.tar.gz"
                sha256 "${{ env.SHA_LINUX }}"
              end
            end

            def install
              bin.install "orca"
            end

            test do
              system "#{bin}/orca", "--version"
            end
          end
          EOF

      - name: Commit and push
        working-directory: tap
        env:
          GH_TOKEN: ${{ secrets.PUBLIC_RELEASE_TOKEN }}
        run: |
          git add Formula/orca.rb
          if git diff --staged --quiet; then
            echo "No changes to formula"
          else
            git commit -m "Update Orca to ${{ env.VERSION }}"
            git push
          fi

  update-winget:
    name: Update Winget Manifest
    needs: build-and-upload
    if: startsWith(github.ref, 'refs/tags/')
    runs-on: windows-latest
    steps:
      - uses: actions/checkout@v4

      - name: Compute version
        shell: pwsh
        run: |
          $version = "${{ github.ref_name }}".TrimStart('v')
          echo "VERSION=$version" | Out-File -FilePath $env:GITHUB_ENV -Encoding utf8 -Append

      - name: Download MSI
        shell: pwsh
        env:
          GH_TOKEN: ${{ secrets.PUBLIC_RELEASE_TOKEN }}
        run: |
          gh release download ${{ github.ref_name }} `
            --repo vanthaita/orca-releases `
            --pattern "OrcaSetup-*.msi"

      - name: Compute SHA256
        shell: pwsh
        run: |
          $msiFile = Get-Item OrcaSetup-*.msi | Select-Object -First 1
          $hash = (Get-FileHash -Path $msiFile.FullName -Algorithm SHA256).Hash
          echo "MSI_SHA256=$hash" | Out-File -FilePath $env:GITHUB_ENV -Encoding utf8 -Append
          echo "MSI_FILENAME=$($msiFile.Name)" | Out-File -FilePath $env:GITHUB_ENV -Encoding utf8 -Append

      - name: Update manifests
        shell: pwsh
        run: |
          # Update version manifest
          (Get-Content winget/vanthaita.Orca.yaml) `
            -replace 'PackageVersion: .*', "PackageVersion: $env:VERSION" |
            Set-Content winget/vanthaita.Orca.yaml

          # Update installer manifest
          (Get-Content winget/vanthaita.Orca.installer.yaml) `
            -replace 'PackageVersion: .*', "PackageVersion: $env:VERSION" `
            -replace 'InstallerUrl: .*', "InstallerUrl: https://github.com/vanthaita/orca-releases/releases/download/${{ github.ref_name }}/$env:MSI_FILENAME" `
            -replace 'InstallerSha256: .*', "InstallerSha256: $env:MSI_SHA256" |
            Set-Content winget/vanthaita.Orca.installer.yaml

          # Update locale manifest
          (Get-Content winget/vanthaita.Orca.locale.en-US.yaml) `
            -replace 'PackageVersion: .*', "PackageVersion: $env:VERSION" `
            -replace 'ReleaseNotes: .*', "ReleaseNotes: |-`n  See release notes at: https://github.com/vanthaita/orca-releases/releases/tag/${{ github.ref_name }}" `
            -replace 'ReleaseNotesUrl: .*', "ReleaseNotesUrl: https://github.com/vanthaita/orca-releases/releases/tag/${{ github.ref_name }}" |
            Set-Content winget/vanthaita.Orca.locale.en-US.yaml

      - name: Create PR to winget-pkgs
        shell: pwsh
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          Write-Host "Winget manifests updated locally. Manual PR creation to microsoft/winget-pkgs required."
          Write-Host "Please follow the instructions at: https://github.com/microsoft/winget-pkgs/blob/master/CONTRIBUTING.md"
          
          # Upload manifests as artifacts for manual submission
          
      - name: Upload Winget Manifests
        uses: actions/upload-artifact@v4
        with:
          name: winget-manifests-${{ env.VERSION }}
          path: winget/
